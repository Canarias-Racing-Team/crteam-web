---
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import type { CarouselItemType } from "@types";

let { items, id, className = "" } = Astro.props;
// Protección extra: nunca null/undefined y siempre array
if (!Array.isArray(items))
  items =
    items && typeof items === "object" && typeof items.length === "number"
      ? Array.from(items)
      : [];
if (!items) items = [];
---

{
  Array.isArray(items) && items.length > 0 ? (
    <div class={className}>
      <div class="carousel w-full h-full" id={id}>
        {/* Carousel items */}
        {items.map((image: CarouselItemType, i: number) => {
          if (!image || typeof image !== "object" || !("src" in image))
            return null;
          const slideId = `slide${i + 1}`;
          const prevId = `#slide${((i - 1 + items.length) % items.length) + 1}`;
          const nextId = `#slide${((i + 1) % items.length) + 1}`;
          return (
            <div
              id={slideId}
              class="carousel-item relative w-full h-full items-center justify-center"
            >
              <Image
                alt={image.alt ?? `Imagen ${i + 1}`}
                class="w-full h-full rounded-box object-cover object-center"
                src={image.src}
                inferSize
                loading="lazy"
              />
              <div class="absolute top-1/2 right-5 left-5 flex -translate-y-1/2 transform justify-between">
                <a href={prevId} class="btn btn-circle">
                  <Icon name="mdi:chevron-left" class="h-5 w-5" />
                </a>
                <a href={nextId} class="btn btn-circle">
                  <Icon name="mdi:chevron-right" class="h-5 w-5" />
                </a>
              </div>
            </div>
          );
        })}
      </div>
      <div class="carousel-buttons flex justify-center join mt-4">
        {/* Carousel buttons */}
        {items.map((item: CarouselItemType, i: number) => {
          if (!item || typeof item !== "object" || !("src" in item))
            return null;
          const idx = i + 1;
          return (
            <a
              href={`#slide${idx}`}
              id={`carousel-btn-${idx}`}
              class="btn btn-circle btn-sm join-item btn-primary"
            >
              {idx}
            </a>
          );
        })}
      </div>
    </div>
  ) : null
}
<script is:inline>
  // Mantiene el color primario en el botón activo
  function setActiveCarouselBtn(selectedIdx = null) {
    const total = document.querySelectorAll('[id^="carousel-btn-"]').length;
    let idx = selectedIdx;
    if (idx === null) {
      const hash = window.location.hash || "#slide1";
      for (let i = 1; i <= total; i++) {
        if (hash === `#slide${i}` || (!window.location.hash && i === 1)) {
          idx = i;
          break;
        }
      }
      if (!idx) idx = 1;
    }
    for (let i = 1; i <= total; i++) {
      const btn = document.getElementById(`carousel-btn-${i}`);
      if (btn) {
        if (i === idx) {
          btn.classList.add("btn-primary");
          btn.setAttribute("aria-current", "page");
        } else {
          btn.classList.remove("btn-primary");
          btn.removeAttribute("aria-current");
        }
      }
    }
  }
  window.addEventListener("hashchange", () => setActiveCarouselBtn());
  window.addEventListener("DOMContentLoaded", () =>
    setTimeout(() => setActiveCarouselBtn(), 10)
  );
  // Al hacer clic en flechas o números, cambia la imagen sin mover el scroll ni el hash
  document.addEventListener("click", function (e) {
    const target = e.target.closest('a[href^="#slide"]');
    if (target) {
      e.preventDefault();
      const hash = target.getAttribute("href");
      if (hash) {
        // Oculta todos los slides
        document.querySelectorAll(".carousel-item").forEach((item) => {
          item.style.display = "none";
        });
        // Muestra solo el slide seleccionado
        const slide = document.querySelector(hash);
        if (slide) {
          slide.style.display = "";
        }
        // Actualiza los botones activos correctamente
        const idx = parseInt(hash.replace("#slide", ""), 10);
        setActiveCarouselBtn(idx);
      }
    }
  });

  // Mostrar solo el slide activo al cargar la página
  function showActiveSlideOnLoad() {
    const hash = window.location.hash || "#slide1";
    document.querySelectorAll(".carousel-item").forEach((item) => {
      item.style.display = "none";
    });
    const slide = document.querySelector(hash);
    if (slide) {
      slide.style.display = "";
    }
  }
  window.addEventListener("DOMContentLoaded", showActiveSlideOnLoad);
  window.addEventListener("hashchange", showActiveSlideOnLoad);
</script>

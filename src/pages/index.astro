---
import Carousel from "@components/Carousel.astro";
import Gallery from "@components/Gallery.astro";
import FlagDivider from "@components/FlagDivider.astro";
import Hero from "@components/Hero.astro";
import Layout from "@layouts/Layout.astro";
import Card from "@components/Card.astro";
import Section from "@components/Section.astro";
import Stats from "@components/Stats.astro";
import { loadImageEntries } from "@utils/imageUtils";
import { texts, createCardContent } from "@utils/texts";
import carComponentsData from "@assets/carComponents.json";
import CarCardsMenu from "@/components/CarCardsMenu.astro";
import type { ImageEntry } from "@types";

export const prerender = true;

// Importar imágenes de socios y equipo
// Se cargan de forma asíncrona para evitar bloqueos en la renderización
let partners: ImageEntry[] = [];
let mainPartners: ImageEntry[] = [];
let teamPictures: ImageEntry[] = [];
let carComponents: any[] = [];

try {
  // Carga las imagenes del equipo
  teamPictures = await loadImageEntries("crt-barcelona-2425");

  // Carga las imágenes de socios
  partners = await loadImageEntries("logos-partners-2425");
  mainPartners = await loadImageEntries("logos-partners-2425/main");
  // Quita de partners las que estén en mainPartners (por file) y concatena mainPartners al principio
  partners = [
    ...mainPartners,
    ...partners.filter(
      (p) => !new Set(mainPartners.map((p) => p.file)).has(p.file)
    ),
  ];

  // Carga las imágenes de componentes del coche
  const carComponentFiles = carComponentsData
    .map((c) =>
      typeof c.src === "string" && !c.src.startsWith("http")
        ? c.src.split("/").pop()
        : null
    )
    .filter(Boolean) as string[];
  const carComponentImages =
    carComponentFiles.length > 0
      ? await loadImageEntries("car-components-2425", carComponentFiles)
      : [];
  carComponents = carComponentsData.map((component) => {
    if (
      component.src &&
      typeof component.src === "string" &&
      !component.src.startsWith("http")
    ) {
      const img = carComponentImages.find(
        (img) => img.file === component.src.split("/").pop()
      );
      return {
        ...component,
        src: img ? img.src : component.src,
        alt: img ? img.alt : component.name,
      };
    }
    return component;
  });

  console.log(
    `Image loading status:`,
    [
      `${partners.length > 0 ? "✅" : "❌"} ${partners.length} partners`,
      `${mainPartners.length > 0 ? "✅" : "❌"} ${mainPartners.length} mainPartners`,
      `${teamPictures.length > 0 ? "✅" : "❌"} ${teamPictures.length} teamPictures`,
      `${carComponentImages.length > 0 ? "✅" : "❌"} ${carComponentImages.length} carComponents`,
    ].join(", ")
  );
} catch (error) {
  console.error("❌ Error loading pictures data:", error);
}
---

<Layout
  id={Astro.self.name}
  description="Primer equipo de Formula Student de Canarias. Estudiantes de la ULL compitiendo internacionalmente con un monoplaza eléctrico. Innovación, formación y pasión por el motor desde las Islas Canarias."
>
  <Hero />

  <FlagDivider />

  <Section id="partners-principal" className="min-h-[200px]">
    {
      mainPartners.length > 0 ? (
        <div class="w-full lg:w-3/4 h-full self-center">
          <Gallery
            items={mainPartners}
            alt="Logos de socios destacados"
            className="justify-between"
          />
        </div>
      ) : (
        <div class="w-full lg:w-3/4 flex self-center justify-center text-center">
          <p class="text-gray-500">Cargando socios destacados...</p>
        </div>
      )
    }
    <Stats className="w-full lg:w-1/4 h-[138px]" />
  </Section>

  <Section id="team">
    <Card
      className="w-full lg:w-2/3"
      buttons={[
        {
          text: "Únete",
          href: texts.links.joinUs,
          icon: "mdi:account-plus",
        },
      ]}
      content={createCardContent(texts.home.team)}
    />
    <Carousel
      items={teamPictures}
      id="team-carousel"
      className="w-full lg:w-1/3 h-[456px] flex flex-col justify-center items-center"
    />
  </Section>

  <Section id="car">
    <Card
      className="w-full lg:w-1/2"
      content={createCardContent(texts.home.car)}
    />
    <CarCardsMenu
      carComponents={carComponents}
      id="car-components-menu"
      className="w-full lg:w-1/2"
    />
  </Section>

  <Section id="partners">
    {
      partners.length > 0 ? (
        <Gallery
          items={partners}
          alt="Logos de todos los socios"
          className="w-full lg:w-3/4 h-full md:h-[414px]"
        />
      ) : (
        <div class="w-full lg:w-3/4 flex self-center justify-center text-center">
          <p class="text-gray-500">Cargando socios...</p>
        </div>
      )
    }
    <Card
      className="w-full lg:w-1/3"
      content={createCardContent(texts.home.contact)}
      buttons={[
        {
          text: "Patrocinio",
          icon: "mdi:account-multiple-plus",
          href: "#contact",
        },
      ]}
    />
  </Section>
</Layout>
